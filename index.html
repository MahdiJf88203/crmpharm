<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>فرم ثبت اطلاعات</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
    (function(){
      const ls = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (ls === 'dark' || (!ls && prefersDark)) document.documentElement.classList.add('dark');
    })();
  </script>
  <meta name="color-scheme" content="light dark" />

  <!-- فونت‌ها -->
  <link rel="preload" href="/fonts/BNazanin.woff2" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face{
      font-family: 'BNazanin';
      src: url('/fonts/BNazanin.woff2') format('woff2');
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003/fonts/webfonts/Vazirmatn.css" rel="stylesheet">

  <!-- Persian Datepicker (Jalali) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>

  <style>
    :root{ --blob1:#60a5fa; --blob2:#a78bfa; --blob3:#34d399; }
    .bg-animated{ background: linear-gradient(120deg,#0ea5e9,#7c3aed,#22c55e,#0ea5e9); background-size: 300% 300%; animation: gradientShift 18s ease infinite; }
    .dark .bg-animated{ background: linear-gradient(120deg,#0b1220,#1f1147,#0c2c21,#0b1220); }
    @keyframes gradientShift{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .blob{ filter: blur(40px); opacity:.30; position:absolute; border-radius:9999px; animation: float 16s ease-in-out infinite; }
    .blob-1{ width:28rem; height:28rem; background:var(--blob1); top:-6rem; inset-inline-start:-6rem; }
    .blob-2{ width:22rem; height:22rem; background:var(--blob2); bottom:-6rem; inset-inline-end:-4rem; animation-delay: -6s; }
    .blob-3{ width:20rem; height:20rem; background:var(--blob3); top:40%; inset-inline-start:50%; transform:translate(-50%,-50%); animation-delay: -3s; }
    @keyframes float{ 0%,100%{ transform: translateY(0) } 50%{ transform: translateY(-20px) } }

    .fade-up{ opacity:0; transform: translateY(12px); animation: fadeUp .7s ease forwards; }
    .fade-up-delay{ animation-delay:.15s }
    .fade-up-delay-2{ animation-delay:.3s }
    @keyframes fadeUp{ to{ opacity:1; transform: translateY(0) } }

    /* پارتیکل‌ها */
    #particles{ position:fixed; inset:0; pointer-events:none; z-index:-5; opacity:.45; }
    .dark #particles{ opacity:.35 }

    body{ font-family: 'BNazanin','Vazirmatn', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Arabic", "Noto Naskh Arabic", sans-serif; }
    h1,h2,h3,h4,h5,h6{ font-weight:800 }

    @media (prefers-reduced-motion: reduce){
      .bg-animated, .blob{ animation: none !important }
    }
  </style>
</head>
<body class="min-h-screen text-gray-900 dark:text-gray-100 relative overflow-x-hidden selection:bg-indigo-200 selection:text-indigo-900 dark:selection:bg-indigo-500/30 dark:selection:text-white">
  <canvas id="particles"></canvas>

  <div class="absolute inset-0 -z-10 bg-animated"></div>
  <div class="blob blob-1 -z-10"></div>
  <div class="blob blob-2 -z-10"></div>
  <div class="blob blob-3 -z-10"></div>
  <div class="absolute inset-0 -z-10 bg-white/60 dark:bg-black/50 backdrop-blur-[2px]"></div>

  <div id="netBanner" class="hidden bg-yellow-100/90 dark:bg-yellow-900/40 border border-yellow-300 dark:border-yellow-800 text-yellow-900 dark:text-yellow-200 px-4 py-2 text-sm text-center">شما آفلاین هستید؛ ارسال فرم ممکن نیست.</div>

  <div class="fixed top-3 inset-x-0 flex justify-center">
    <button id="themeToggle" class="px-3 py-1.5 rounded-full text-xs font-medium bg-white/80 dark:bg-zinc-900/70 shadow ring-1 ring-black/5 backdrop-blur hover:scale-[1.02] transition">
      <span class="inline dark:hidden">🌙 حالت تیره</span>
      <span class="hidden dark:inline">☀️ حالت روشن</span>
    </button>
  </div>

  <main class="max-w-2xl mx-auto p-4">
    <section class="fade-up bg-white/90 dark:bg-zinc-900/70 rounded-3xl shadow-2xl shadow-black/10 ring-1 ring-black/5 dark:ring-white/10 p-6 sm:p-8 mt-12 backdrop-blur">
      <header class="mb-6 text-center">
        <h1 class="text-3xl font-extrabold tracking-tight">فرم ثبت اطلاعات</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300 mt-2">نام، نام خانوادگی و شماره تماس <span class="font-semibold">الزامی</span> هستند — بقیه اختیاری.</p>
      </header>

      <div id="alert" class="hidden mb-4 rounded-xl border p-3 text-sm"></div>

      <form id="leadForm" class="space-y-5" novalidate>
        <div class="hidden">
          <label>وب‌سایت</label>
          <input name="website" autocomplete="off" tabindex="-1" />
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 fade-up fade-up-delay">
          <div class="group">
            <label for="first_name" class="block text-sm mb-1">نام *</label>
            <input id="first_name" name="first_name" required class="w-full border border-zinc-200 dark:border-zinc-700 bg-white/80 dark:bg-zinc-800/60 rounded-2xl px-3 py-2 focus:outline-none focus:ring-4 focus:ring-indigo-200/70 dark:focus:ring-indigo-500/30 focus:border-indigo-500 transition shadow-sm group-hover:shadow" />
            <p data-err="first_name" class="hidden text-xs text-red-600 mt-1"></p>
          </div>
          <div class="group">
            <label for="last_name" class="block text-sm mb-1">نام خانوادگی *</label>
            <input id="last_name" name="last_name" required class="w-full border border-zinc-200 dark:border-zinc-700 bg-white/80 dark:bg-zinc-800/60 rounded-2xl px-3 py-2 focus:outline-none focus:ring-4 focus:ring-indigo-200/70 dark:focus:ring-indigo-500/30 focus:border-indigo-500 transition shadow-sm group-hover:shadow" />
            <p data-err="last_name" class="hidden text-xs text-red-600 mt-1"></p>
          </div>
        </div>

        <div class="fade-up fade-up-delay">
          <label for="phone" class="block text-sm mb-1">شماره تماس *</label>
          <input id="phone" name="phone" required inputmode="tel" placeholder="مثلاً 09123456789 یا +989123456789"
                 class="w-full border border-zinc-200 dark:border-zinc-700 bg-white/80 dark:bg-zinc-800/60 rounded-2xl px-3 py-2 focus:outline-none focus:ring-4 focus:ring-indigo-200/70 dark:focus:ring-indigo-500/30 focus:border-indigo-500 transition shadow-sm" />
          <div class="flex items-center justify-between mt-1">
            <p class="text-xs text-gray-500 dark:text-gray-400">مجاز: 09xxxxxxxxx یا +989xxxxxxxxx</p>
            <p data-err="phone" class="hidden text-xs text-red-500"></p>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 fade-up fade-up-delay-2">
          <div class="group">
            <label for="national_id" class="block text-sm mb-1">کد ملی (اختیاری)</label>
            <input id="national_id" name="national_id" inputmode="numeric" maxlength="10" minlength="10"
                   class="w-full border border-zinc-200 dark:border-zinc-700 bg-white/80 dark:bg-zinc-800/60 rounded-2xl px-3 py-2 focus:outline-none focus:ring-4 focus:ring-indigo-200/70 dark:focus:ring-indigo-500/30 focus:border-indigo-500 transition shadow-sm group-hover:shadow" />
            <p data-err="national_id" class="hidden text-xs text-red-500 mt-1"></p>
          </div>
          <div class="group">
            <label for="birth_date" class="block text-sm mb-1">تاریخ تولد (اختیاری - شمسی)</label>
            <input id="birth_date" type="text" name="birth_date" placeholder="مثلاً 1403/07/07"
                   class="w-full border border-zinc-200 dark:border-zinc-700 bg-white/80 dark:bg-zinc-800/60 rounded-2xl px-3 py-2 focus:outline-none focus:ring-4 focus:ring-indigo-200/70 dark:focus:ring-indigo-500/30 focus:border-indigo-500 transition shadow-sm group-hover:shadow" />
            <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">فرمت ورودی: YYYY/MM/DD — تقویم شمسی</p>
            <p data-err="birth_date" class="hidden text-xs text-red-500 mt-1"></p>
          </div>
        </div>

        <button id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 active:scale-[.99] text-white rounded-2xl py-3 font-semibold flex items-center justify-center gap-2 transition focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-700/40">
          <svg id="btnSpinner" class="hidden animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="btnText">ارسال</span>
        </button>

      </form>
    </section>
  </main>

  <!-- راه‌اندازی Datepicker شمسی -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.$ && window.$('#birth_date').length) {
        window.$('#birth_date').persianDatepicker({
          format: 'YYYY/MM/DD',
          initialValue: false,
          autoClose: true,
          observer: true,
          calendar: { persian: { locale: 'fa' } }
        });
      }
    });
  </script>

  <!-- اسکریپت اصلی (ماژول) -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://cytnpwducpuaidhfbhap.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dG5wd2R1Y3B1YWlkaGZiaGFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNjY4NDEsImV4cCI6MjA3NDY0Mjg0MX0.vpf73Da30nptQFQ3keZbG3rYwcJt86jYJp6HG5lWMbk';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const netBanner = document.getElementById('netBanner');
    const form = document.getElementById('leadForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnSpinner = document.getElementById('btnSpinner');
    const btnText = document.getElementById('btnText');
    const themeToggle = document.getElementById('themeToggle');

    themeToggle?.addEventListener('click', () => {
      const root = document.documentElement;
      const willDark = !root.classList.contains('dark');
      root.classList.toggle('dark', willDark);
      localStorage.setItem('theme', willDark ? 'dark' : 'light');
    });

    function updateNetBanner() {
      if (navigator.onLine) netBanner.classList.add('hidden');
      else netBanner.classList.remove('hidden');
    }
    window.addEventListener('online', updateNetBanner);
    window.addEventListener('offline', updateNetBanner);
    updateNetBanner();

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.classList.remove('hidden');
      const classes = {
        info: 'border-blue-300 bg-blue-50 text-blue-900 dark:bg-blue-900/30 dark:text-blue-100 dark:border-blue-800',
        success: 'border-green-300 bg-green-50 text-green-900 dark:bg-green-900/30 dark:text-green-100 dark:border-green-800',
        error: 'border-red-300 bg-red-50 text-red-900 dark:bg-red-900/30 dark:text-red-100 dark:border-red-800',
        warn: 'border-yellow-300 bg-yellow-50 text-yellow-900 dark:bg-yellow-900/30 dark:text-yellow-100 dark:border-yellow-800'
      };
      alert.className = `mb-4 rounded-xl border p-3 text-sm shadow ${classes[type] || classes.info}`;
      setTimeout(() => alert.classList.add('hidden'), 5000);
    }

    function sanitize(str) { return (str || '').toString().trim(); }
    function normalizePhone(p) {
      p = (p || '').toString().replace(/[\s\-()]/g, '');
      if (p.startsWith('+98')) return '0' + p.slice(3);
      if (p.startsWith('0098')) return '0' + p.slice(4);
      return p;
    }
    function validPhone(p){ return /^09\d{9}$/.test(normalizePhone(p)); }

    // تبدیل تاریخ شمسی (YYYY/MM/DD) به میلادی (YYYY-MM-DD) برای ذخیره در Postgres
    function jalaliToGregorianISO(jdateStr){
      try{
        const parts = (jdateStr || '').split('/').map(Number);
        if (parts.length !== 3 || parts.some(isNaN)) return null;
        const { gy, gm, gd } = window.jalaali.toGregorian(parts[0], parts[1], parts[2]);
        const mm = String(gm).padStart(2,'0');
        const dd = String(gd).padStart(2,'0');
        return `${gy}-${mm}-${dd}`;
      }catch{ return null; }
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitBtn.classList.toggle('opacity-70', loading);
      btnSpinner.classList.toggle('hidden', !loading);
      btnText.textContent = loading ? 'در حال ارسال…' : 'ارسال';
    }

    const loadTime = Date.now();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!navigator.onLine) { showAlert('شما آفلاین هستید.', 'warn'); return; }

      const timeSpent = (Date.now() - loadTime) / 1000;
      const honeypot = sanitize((new FormData(form)).get('website'));
      if (honeypot) { showAlert('ارسال نامعتبر تشخیص داده شد.', 'warn'); return; }
      if (timeSpent < 2) { showAlert('ارسال بسیار سریع بود؛ لطفاً دوباره تلاش کنید.', 'warn'); return; }

      const data = Object.fromEntries(new FormData(form).entries());
      const first_name = sanitize(data.first_name);
      const last_name  = sanitize(data.last_name);
      const phone      = sanitize(data.phone);
      const national_id= sanitize(data.national_id);
      const birth_date = sanitize(data.birth_date);

      if (first_name.length < 2 || last_name.length < 2 || !validPhone(phone)) {
        showAlert('لطفاً نام، نام خانوادگی و شماره تماس معتبر وارد کنید.', 'warn');
        return;
      }

      let birthISO = null;
      if (birth_date) {
        birthISO = jalaliToGregorianISO(birth_date);
        if (!birthISO) { showAlert('فرمت تاریخ تولد نامعتبر است. مثال: 1403/07/07', 'warn'); return; }
      }

      setLoading(true);
      try {
        const { error } = await supabase.from('leads').insert({
          first_name, last_name,
          phone: normalizePhone(phone),
          national_id: national_id || null,
          birth_date: birthISO
        });
        if (error) throw error;
        showAlert('ثبت شد! متشکرم 🌟', 'success');
        form.reset();
      } catch (err) {
        console.error(err);
        showAlert('خطا در ثبت اطلاعات. دوباره تلاش کنید.', 'error');
      } finally {
        setLoading(false);
      }
    });

    // پارتیکل‌ها
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    let w, h, dpr, stars = [], rafId = null;
    function resize(){
      dpr = window.devicePixelRatio || 1; w = canvas.clientWidth = window.innerWidth; h = canvas.clientHeight = window.innerHeight;
      canvas.width = Math.floor(w * dpr); canvas.height = Math.floor(h * dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
      const target = Math.min(120, Math.floor((w*h)/25000));
      stars = Array.from({length: target}, () => ({ x: Math.random()*w, y: Math.random()*h, r: Math.random()*1.6+0.4, vx: (Math.random()-.5)*0.2, vy: (Math.random()-.5)*0.2, a: Math.random()*0.5+0.3 }));
    }
    function draw(){
      ctx.clearRect(0,0,w,h);
      const isDark = document.documentElement.classList.contains('dark');
      ctx.fillStyle = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)';
      for (const s of stars){
        ctx.globalAlpha = s.a; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); s.x += s.vx; s.y += s.vy;
        if (s.x < -5) s.x = w+5; if (s.x > w+5) s.x = -5; if (s.y < -5) s.y = h+5; if (s.y > h+5) s.y = -5;
      }
      rafId = requestAnimationFrame(draw);
    }
    function startParticles(){ if (!window.matchMedia || !window.matchMedia('(prefers-reduced-motion: reduce)').matches){ cancelAnimationFrame(rafId); resize(); draw(); } }
    window.addEventListener('resize', resize);
    startParticles();
  </script>
</body>
</html>
